## DHCP in Action

DHCP is an application layer protocol, which means it relies on the transport, network, data link and physical layers to operate. But you might have noticed that the entire point of DHCP is to help configure the network layer itself. Let's take a look at exactly how DHCP works and how it accomplishes communications without a network layer configuration in place. Warning, geeky stuff ahead. The process by which a client configured to use DHCP attempts to get network configuration information is known as DHCP discovery. The DHCP discovery process has four steps. First, we have the server discovery step. The DHCP clients sends what's known as a DHCP discover message out onto the network. Since the machine doesn't have an IP and it doesn't know the IP of the DHCP server, a specially crafted broadcast message is formed instead. DHCP listens on UDP port 67 and DHCP discovery messages are always sent from UDP port 68. So the DHCPDISCOVER message is encapsulated in a UDP datagram with a destination port of 67 and a source port of 68. This is then encapsulated inside of an IP datagram with a destination IP of 255.255.255.255, and a source IP of 0.0.0.0. This broadcast message would get delivered to every node on the local area network. And if a DHCP server is present, it would receive this message. Next, the DHCP server would examine its own configuration and would make a decision on what, if any, IP address to offer to the client. This would depend on if it's configured to run with dynamic, automatic or fixed address allocation. The response would be sent as a DHCPOFFER message with a destination port of 68, a source port of 67, a destination broadcast IP of 255.255.255.255, and its actual IP as the source. Since the DHCP offer is also a broadcast, it would reach every machine on the network. The original client would recognize that this message was intended for itself. This is because the DHCPOFFER has the field that specifies the MAC address of the client that sent the DHCPDISCOVER message. The client machine would now process this DHCPOFFER to see what IP is being offered to it. Technically, a DHCP client could reject this offer. It's totally possible for multiple DHCP servers to be running on the same network, and for a DHCP client to be configured to only respond to an offer of an IP within a certain range. But this is rare. More often, the DHCP client would respond to the DHCPOFFER message with a DHCPREQUEST message. This message essentially says, yes, I would like to have an IP that you offer to me. Since the IP hasn't been assigned yet, this is again sent from an IP of 0.0.0.0, and to the broadcast IP of 255.255.255.255. Finally, the DHCP server receives the DHCPREQUEST message and responds with a DHCPACK or DHCP acknowledgement message. This message is again sent to a broadcast IP of 255.255.255.255, and with a source IP corresponding to the actual IP of the DHCP server. Again, the DHCP client would recognize that this message was intended for itself by inclusion of its MAC address in one of the message fields. The networking stack on the client computer can now use the configuration information presented to it by the DHCP server to set up its own network layer configuration. At this stage, the computer that's acting as the DHCP client should have all the information it needs to operate in a full fledged manner on the network it's connected to. All of this configuration is known as DHCP lease as it includes an expiration time. A DHCP lease might last for days or only for a short amount of time. Once a lease has expired, the DHCP client would need to negotiate a new lease by performing the entire DHCP discovery process all over again. A client can also release its lease to the DHCP server, which it would do when it disconnects from the network. This would allow the DHCP server to return the IP address that was assigned to its pool of available IPs. Now that you've seen DHCP in action, we've got a short quiz for you. When you're finished, it's time for you to learn the basics of NAT.



DHCP 是一种应用层协议，这意味着它依赖于传输、 网络、数据链路和物理层来运行。 但是，您可能已经注意到 DHCP 的整个重点 是帮助配置网络层本身。 让我们来看一下 DHCP 的工作原理，以及 它如何在没有网络层配置的情况下完成通信。 警告，前面怪异的东西 配置为使用 DHCP 的客户端 尝试获取网络配置信息的过程称为 DHCP 发现。 DHCP 发现过程有四个步骤。 首先，我们有服务器发现步骤。 DHCP 客户端将所谓的 DHCP 发现邮件发送 到网络上。 由于计算机没有 IP 并且不知道 DHCP 服务器的 IP，因此会 形成特殊设计的广播消息。 DHCP 侦听 UDP 端口 67， DHCP 发现消息始终从 UDP 端口 68 发送。 因此，DHCPDISOVIC 消息封装在 目标端口为 67，源端口为 68 的 UDP 数据报中。 然后将其封装在 IP 数据报内 ，目标 IP 为 255.255.255 ，源 IP 为 0.0.0。 此广播消息将传递到局域网上的每个节点。 如果存在 DHCP 服务器，它将收到此消息。 接下来，DHCP 服务器将检查自己的配置 ，并决定向客户端提供哪些 IP 地址（如果有）。 这取决于它是否配置为使用动态、自动或 固定地址分配运行。 响应将以 DHCPOFFER 消息的形式发送，目的端口为 68， 源端口为 67，目的广播 IP 为 255.255.255.255，其实际 IP 作为源。由于 DHCP 产品也是一个广播，因此 它可以到达网络上的每台计算机。 原始客户端会认识到此消息是针对自己的。 这是因为 DHCPOFFER 具有指定 发送 DHCPDISOFE 消息的客户端的 MAC 地址的字段。 客户端计算机现在将处理此 DHCPOFER， 以查看提供给它的 IP。 从技术上讲，DHCP 客户端可以拒绝此提供。 完全有可能在 同 一网络上运行多个 DHCP 服务器，并且 DHCP 客户端配置为仅响应特定范围内的 IP 提供。 但这是罕见的更多的情况下，DHCP 客户端会 使用 DHCPREQuest 消息来响应 DHCPOFFER 消息。 这条消息基本上说，是的， 我希望有一个你提供给我的知识产权。 由于尚未分配 IP，因 此 将再次从 0.0.0.0 的 IP 发送到 255.255.255.255 的广播 IP。 最后，DHCP 服务器接收 DHCPREQuest 消息，并 通过 DHCPACK 或 DHCP 确认消息进行响应。 此消息将再次发送到 255.255.255.255 的广播 IP， 并使用与 DHCP 服务器的实际 IP 对应的源 IP。 同 样，DHCP 客户端将识别此邮件的目的是 通过在其中一个消息字段中包含其 MAC 地址来自行。 客户端计算机上的网络堆栈现在可 以使用 DHCP 服务器提供给它的配置信息 来设置自己的网络层配置。在此阶段， 充当 DHCP 客户端的计算机应该拥有所 需的所有信息，以便在所连接的网络上以完全成熟的方式运行。所有这些配置都称为 DHCP 租用，因为它包含过期时间。 DHCP 租约可能持续数天，也可能只持续很短的时间。 租约过期后，DHCP 客户端将需要 通过重新执行整个 DHCP 发现过程来协商新租约。 客户端还可以将其租约释放给 DHCP 服务器，当 它与网络断开连接时，它会这样做。 这将允许 DHCP 服务器返回 分配给其可用 IP 池的 IP 地址。现在您已经看到 DHCP 在运作中，我们为您准备了一个简短的测验。 完成后，现在是时候了解 NAT 的基础知识了。